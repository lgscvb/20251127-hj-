# Hour Jungle CRM - Nginx 配置
# 複製到: /etc/nginx/sites-available/hourjungle
# 啟用: sudo ln -s /etc/nginx/sites-available/hourjungle /etc/nginx/sites-enabled/
# 移除預設: sudo rm /etc/nginx/sites-enabled/default
# 測試: sudo nginx -t
# 重載: sudo systemctl reload nginx

server {
    listen 80;
    server_name _;  # 替換成你的網域或 IP，例如: crm.yourcompany.com 或 35.x.x.x

    client_max_body_size 20M;

    # 後端 API (/api/*)
    location ^~ /api {
        root /var/www/hourjungle/backend/public;

        # 嘗試直接找檔案，否則轉到 Laravel
        try_files $uri /index.php?$query_string;

        location ~ \.php$ {
            fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME /var/www/hourjungle/backend/public/index.php;
            include fastcgi_params;
        }
    }

    # LINE Webhook (/webhook/*)
    location ^~ /webhook {
        root /var/www/hourjungle/backend/public;
        try_files $uri /index.php?$query_string;

        location ~ \.php$ {
            fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME /var/www/hourjungle/backend/public/index.php;
            include fastcgi_params;
        }
    }

    # 前端 React SPA (所有其他路徑)
    location / {
        root /var/www/hourjungle/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 靜態資源快取
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        root /var/www/hourjungle/frontend/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 禁止訪問隱藏檔案
    location ~ /\. {
        deny all;
    }

    # 日誌
    access_log /var/log/nginx/hourjungle_access.log;
    error_log /var/log/nginx/hourjungle_error.log;
}
