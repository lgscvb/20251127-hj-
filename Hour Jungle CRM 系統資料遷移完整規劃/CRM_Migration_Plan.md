# Hour Jungle CRM ç³»çµ±è³‡æ–™é·ç§»å®Œæ•´è¦åŠƒ

## ğŸ“Š ç¾æœ‰è³‡æ–™ç›¤é»

### è³‡æ–™ä¾†æº
1. **å®¢æˆ¶è³‡æ–™è¡¨crm.xlsx** (ä¸»é¤¨ - å°ç£å¤§é“)
   - ç¸½è¡¨: 146 ç­†å®¢æˆ¶
   - å·²çµæŸ: 142 ç­†æ­·å²å®¢æˆ¶
   - ä½£é‡‘: 18 ç­†ä½£é‡‘è¨˜éŒ„

2. **ç’°ç‘å®¢æˆ¶è³‡æ–™è¡¨crm.xlsx** (ç’°ç‘é¤¨)
   - ç’°ç‘CRM: 69 ç­†å®¢æˆ¶
   - å·²çµæŸ: 1 ç­†æ­·å²å®¢æˆ¶
   - ä½£é‡‘: 8 ç­†ä½£é‡‘è¨˜éŒ„

3. **2025_å®¢æˆ¶ç¹³è²».xlsx** + **2026å®¢æˆ¶ç¹³è²».xlsx**
   - æŒ‰æœˆä»½åˆ†å·¥ä½œè¡¨ (1-12æœˆ)
   - ç¹³è²»è¨˜éŒ„ä¸å®Œæ•´

**ç¸½è¨ˆéœ€é·ç§»:**
- æ´»èºå®¢æˆ¶: 215 ç­†
- æ­·å²å®¢æˆ¶: 143 ç­†
- ä½£é‡‘è¨˜éŒ„: 26 ç­†
- ç¹³è²»è¨˜éŒ„: éœ€æ•´åˆçµ±è¨ˆ

---

## ğŸ” è³‡æ–™å“è³ªå•é¡Œç™¼ç¾

### åš´é‡å•é¡Œ (å¿…é ˆè™•ç†)

#### 1. æ¬„ä½å‘½åä¸ä¸€è‡´
**ä¸»é¤¨ vs ç’°ç‘:**
| ä¸»é¤¨ | ç’°ç‘ | å»ºè­°æ¨™æº–åŒ– |
|------|------|-----------|
| å…¬å¸ | å…¬å¸åç¨± | company_name |
| Co number | çµ±ç·¨ | tax_id |
| é¡åˆ¥ | é¡åˆ¥ | customer_type |

#### 2. æ—¥æœŸæ ¼å¼æ··äº‚
**ç™¼ç¾çš„æ ¼å¼:**
- `113/06/05` (æ°‘åœ‹å¹´)
- `114/04/08` (æ°‘åœ‹å¹´)
- `2025-01-06 00:00:00` (datetimeç‰©ä»¶)
- `10/6/8` (???)
- `11408/17` (éŒ¯èª¤è¼¸å…¥)

**éœ€è¦çµ±ä¸€ç‚º:** `YYYY-MM-DD` (è¥¿å…ƒå¹´)

#### 3. é‡‘é¡æ ¼å¼ä¸ä¸€è‡´
**ç™¼ç¾çš„æ ¼å¼:**
- `1800/m` (å­—ä¸²)
- `12000/m` (å­—ä¸²)
- `21600` (æ•¸å­—)
- `21600.0` (æµ®é»æ•¸)

**éœ€è¦åˆ†é›¢:** é‡‘é¡ + é€±æœŸ

#### 4. ç¹³è²»æ–¹å¼ç·¨ç¢¼ä¸ä¸€è‡´
**ç™¼ç¾çš„å€¼:**
- `Y` / `y` (ä¸€å¹´?)
- `M` (æœˆç¹³?)
- `6M` / `6m` (åŠå¹´ç¹³?)
- `2Y` / `2y` (å…©å¹´?)
- `110/6/8` (???)

**éœ€è¦æ¨™æº–åŒ–**

#### 5. æŠ¼é‡‘æ¬„ä½æ··äº‚
**ç™¼ç¾çš„æ ¼å¼:**
- `22000/æœªé€€`
- `3000/æœªé€€`
- `6000/æœªé€€`
- `N`
- `n`
- `Y`
- ç©ºå€¼

**éœ€è¦æ‹†åˆ†:** æŠ¼é‡‘é‡‘é¡ + é€€æ¬¾ç‹€æ…‹

#### 6. å¤§é‡ç¼ºå¤±å€¼
**ç¼ºå¤±ç‡ >50% çš„æ¬„ä½:**
- æ¨™è¨»: 87% ç¼ºå¤±
- è¡Œæ¥­å‚™è¨»: 71% ç¼ºå¤±
- ç½®ç‰©æ«ƒ: 96% ç¼ºå¤±
- Mail: 97% ç¼ºå¤±
- ç”Ÿæ—¥: 25% ç¼ºå¤±
- Id number: 23% ç¼ºå¤±

#### 7. çµ±ç·¨æ ¼å¼ä¸çµ±ä¸€
**ç™¼ç¾çš„æ ¼å¼:**
- `87279184` (8ä½æ•¸å­—)
- `60209751.0` (æµ®é»æ•¸)
- `N` (???)
- ç©ºå€¼

#### 8. ç¹³è²»è¡¨æ ¼çµæ§‹æ··äº‚
- æ¬„ä½åç¨±éƒ½æ˜¯ `Unnamed: 0` ~ `Unnamed: 6`
- å¤§é‡ç©ºç™½è¡Œ
- å¯¦éš›ç¹³è²»æ—¥/é‡‘é¡å¤§å¤šæ˜¯ç©ºå€¼
- ç„¡æ³•é—œè¯åˆ°å®¢æˆ¶ä¸»æª” (æ²’æœ‰æ¸…æ¥šçš„ID)

---

## ğŸ—ºï¸ æ¬„ä½å°æ‡‰è¡¨ (Mapping Table)

### A. å®¢æˆ¶ä¸»æª” â†’ customers è¡¨

| èˆŠæ¬„ä½åç¨± | ä¸»é¤¨ | ç’°ç‘ | æ–°æ¬„ä½åç¨± | è³‡æ–™å‹æ…‹ | æ¸…æ´—è¦å‰‡ |
|-----------|------|------|-----------|---------|---------|
| ç·¨è™Ÿ | âœ“ | âœ“ | legacy_id | VARCHAR(20) | ä¿ç•™åŸå§‹ç·¨è™Ÿ,åŠ å‰ç¶´ HQ-/HR- |
| å§“å | âœ“ | âœ“ | name | VARCHAR(100) | å»ç©ºç™½,å¿…å¡« |
| å…¬å¸/å…¬å¸åç¨± | âœ“ | âœ“ | company_name | VARCHAR(200) | ç©ºå€¼æ™‚å¡«"å€‹äºº" |
| é¡åˆ¥ | âœ“ | âœ“ | business_type | ENUM | æ˜ å°„è¦å‰‡è¦‹ä¸‹è¡¨ |
| é …ç›® | âœ“ | âœ“ | contract_type | ENUM | æ˜ å°„è¦å‰‡è¦‹ä¸‹è¡¨ |
| Co number/çµ±ç·¨ | âœ“ | âœ“ | company_tax_id | VARCHAR(8) | è½‰å­—ä¸²,å»å°æ•¸é»,é©—è­‰8ä½æ•¸ |
| Id number | âœ“ | âœ“ | id_number | VARCHAR(10) | è½‰å¤§å¯«,é©—è­‰æ ¼å¼ |
| ç”Ÿæ—¥ | âœ“ | âœ“ | birthday | DATE | è½‰è¥¿å…ƒå¹´,æ ¼å¼çµ±ä¸€ |
| Add | âœ“ | âœ“ | address | TEXT | ä¿ç•™ |
| è¯çµ¡é›»è©± | âœ“ | âœ“ | phone | VARCHAR(20) | è½‰å­—ä¸²,å»é™¤éæ•¸å­— |
| Mail | âœ“ | âœ“ | email | VARCHAR(100) | é©—è­‰æ ¼å¼ |
| è¡Œæ¥­å‚™è¨» | âœ“ | âœ“ | industry_notes | TEXT | ä¿ç•™ |

### B. åˆç´„ç›¸é—œ â†’ contracts è¡¨

| èˆŠæ¬„ä½åç¨± | æ–°æ¬„ä½åç¨± | æ¸…æ´—è¦å‰‡ |
|-----------|-----------|---------|
| èµ·å§‹æ—¥æœŸ | start_date | è½‰è¥¿å…ƒå¹´ YYYY-MM-DD |
| åˆç´„åˆ°æœŸæ—¥ | end_date | è½‰è¥¿å…ƒå¹´ YYYY-MM-DD |
| ç°½ç´„æ—¥æœŸ | signed_at | è½‰è¥¿å…ƒå¹´ YYYY-MM-DD |
| ç¹³è²»æ–¹å¼ | payment_cycle | è¦‹ä¸‹æ–¹æ˜ å°„è¦å‰‡ |
| é‡‘é¡ | monthly_rent | æå–æ•¸å­—éƒ¨åˆ†,å»é™¤ "/m" |
| æŠ¼é‡‘ | deposit | æå–æ•¸å­—éƒ¨åˆ†,å»é™¤ "æœªé€€" |
| æ¨™è¨» | notes | ä¿ç•™ç‚ºå‚™è¨» |
| ç½®ç‰©æ«ƒ | addon_services | è‹¥æœ‰å€¼,åŠ å…¥ JSON åŠ å€¼æœå‹™ |

### C. ä½£é‡‘ç›¸é—œ â†’ commission_payments è¡¨

| èˆŠæ¬„ä½åç¨± | æ–°æ¬„ä½åç¨± | æ¸…æ´—è¦å‰‡ |
|-----------|-----------|---------|
| å®¢æˆ¶ | customer_name | éœ€é—œè¯åˆ° customers è¡¨ |
| ä»‹ç´¹äºº | referrer_name | éœ€å»ºç«‹ accounting_firms è¡¨ |
| ç°½ç´„æ™‚é–“ | contract_start | è½‰è¥¿å…ƒå¹´ |
| é‡‘é¡ | commission_amount | æå–æ•¸å­—éƒ¨åˆ† |
| ä½£é‡‘çµ¦ä»˜æ—¥æœŸ | paid_at | è½‰è¥¿å…ƒå¹´,è‹¥ "ä½£é‡‘å·²ä»˜" å‰‡æ¨™è¨˜ paid |

### D. ç¹³è²»è¨˜éŒ„ â†’ payments è¡¨

| èˆŠæ¬„ä½åç¨± | æ–°æ¬„ä½åç¨± | æ¸…æ´—è¦å‰‡ |
|-----------|-----------|---------|
| Unnamed: 0 | legacy_customer_id | å˜—è©¦é—œè¯ |
| Unnamed: 1 | customer_name | ç”¨æ–¼é—œè¯ |
| ç¹³è²»æ—¥ | paid_at | è½‰è¥¿å…ƒå¹´ |
| ç¹³è²»é‡‘é¡ | amount | æ•¸å­—æ ¼å¼ |
| ä¸‹æ¬¡ç¹³è²»æ—¥ | next_due_date | è½‰è¥¿å…ƒå¹´ |
| line è¨˜äº‹æœ¬ | notes | ä¿ç•™ |
| ç™¼ç¥¨ | invoice_status | âœ”ï¸ = issued |

---

## ğŸ“‹ è³‡æ–™æ¸…æ´—è¦å‰‡è©³ç´°å®šç¾©

### 1. é¡åˆ¥ (business_type) æ˜ å°„

| èˆŠå€¼ | æ–°å€¼ | èªªæ˜ |
|------|------|------|
| ç©ºå€¼ / NaN | individual | å€‹äººå®¢æˆ¶ |
| è¡Œè™Ÿ | sole_proprietorship | è¡Œè™Ÿ |
| å…¬å¸ | company | å…¬å¸ |
| N | individual | å€‹äºº |

### 2. é …ç›® (contract_type) æ˜ å°„

| èˆŠå€¼ | æ–°å€¼ | èªªæ˜ |
|------|------|------|
| ç‡Ÿç™» | virtual_office | è™›æ“¬è¾¦å…¬å®¤ |
| è‡ªç”±åº§ | coworking_flexible | å…±äº«ç©ºé–“è‡ªç”±åº§ |
| è¾¦å…¬å®¤A / è¾¦å…¬å®¤ | coworking_fixed | å…±äº«ç©ºé–“å›ºå®šåº§ |
| ç©ºå€¼ | virtual_office | é è¨­ç‚ºç‡Ÿç™» |

### 3. ç¹³è²»æ–¹å¼ (payment_cycle) æ˜ å°„

| èˆŠå€¼ | æ–°å€¼ | èªªæ˜ |
|------|------|------|
| Y / y | annual | å¹´ç¹³ |
| M | monthly | æœˆç¹³ |
| 6M / 6m | semi_annual | åŠå¹´ç¹³ |
| 2Y / 2y | biennial | å…©å¹´ç¹³ |
| ç©ºå€¼ | monthly | é è¨­æœˆç¹³ |
| å…¶ä»–æ—¥æœŸæ ¼å¼ | monthly | ç•°å¸¸å€¼é è¨­æœˆç¹³ |

### 4. æ—¥æœŸè½‰æ›è¦å‰‡

```python
def convert_date(date_str):
    """
    çµ±ä¸€æ—¥æœŸæ ¼å¼ç‚º YYYY-MM-DD
    
    è™•ç†æ ¼å¼:
    - 113/06/05 â†’ 2024-06-05 (æ°‘åœ‹ +1911)
    - 114/04/08 â†’ 2025-04-08
    - 2025-01-06 00:00:00 â†’ 2025-01-06
    - 10/6/8 â†’ æ‹†è§£å¾Œ +1911
    - NaT / NaN â†’ NULL
    """
    if pd.isna(date_str):
        return None
    
    # å·²æ˜¯ datetime ç‰©ä»¶
    if isinstance(date_str, pd.Timestamp):
        return date_str.strftime('%Y-%m-%d')
    
    # å­—ä¸²è™•ç†
    date_str = str(date_str).strip()
    
    # æ°‘åœ‹å¹´æ ¼å¼ 113/06/05
    if '/' in date_str:
        parts = date_str.split('/')
        year = int(parts[0]) + 1911  # è½‰è¥¿å…ƒ
        month = int(parts[1])
        day = int(parts[2])
        return f"{year:04d}-{month:02d}-{day:02d}"
    
    # ISOæ ¼å¼
    if '-' in date_str:
        return date_str.split(' ')[0]  # å»é™¤æ™‚é–“éƒ¨åˆ†
    
    # ç„¡æ³•è§£æ
    return None
```

### 5. é‡‘é¡æå–è¦å‰‡

```python
def extract_amount(amount_str):
    """
    å¾ "1800/m" æå– 1800
    å¾ "12000/m" æå– 12000
    å¾ 21600 ç›´æ¥è¿”å›
    """
    if pd.isna(amount_str):
        return None
    
    # å·²æ˜¯æ•¸å­—
    if isinstance(amount_str, (int, float)):
        return int(amount_str)
    
    # å­—ä¸²è™•ç†
    amount_str = str(amount_str).strip()
    
    # æå–æ•¸å­—éƒ¨åˆ†
    import re
    match = re.search(r'(\d+)', amount_str)
    if match:
        return int(match.group(1))
    
    return None
```

### 6. æŠ¼é‡‘æ‹†åˆ†è¦å‰‡

```python
def parse_deposit(deposit_str):
    """
    å¾ "6000/æœªé€€" æ‹†åˆ†ç‚º
    amount: 6000, status: 'not_refunded'
    
    å¾ "Y" / "N" è™•ç†ç‚º
    amount: NULL, status: 'unknown'
    """
    if pd.isna(deposit_str):
        return None, 'unknown'
    
    deposit_str = str(deposit_str).strip()
    
    # æ•¸å­— + ç‹€æ…‹æ ¼å¼
    if '/' in deposit_str:
        parts = deposit_str.split('/')
        amount = int(parts[0])
        status = 'not_refunded' if 'æœªé€€' in parts[1] else 'refunded'
        return amount, status
    
    # Y/N æ ¼å¼
    if deposit_str.upper() in ['Y', 'N']:
        return None, 'unknown'
    
    # ç´”æ•¸å­—
    if deposit_str.isdigit():
        return int(deposit_str), 'not_refunded'
    
    return None, 'unknown'
```

### 7. çµ±ç·¨æ¸…æ´—è¦å‰‡

```python
def clean_tax_id(tax_id):
    """
    çµ±ä¸€ç‚º8ä½æ•¸å­—å­—ä¸²
    87279184 â†’ "87279184"
    60209751.0 â†’ "60209751"
    N â†’ NULL
    """
    if pd.isna(tax_id):
        return None
    
    tax_id = str(tax_id).strip()
    
    # ç§»é™¤å°æ•¸é»
    if '.' in tax_id:
        tax_id = tax_id.split('.')[0]
    
    # é©—è­‰æ˜¯å¦ç‚º8ä½æ•¸å­—
    if tax_id.isdigit() and len(tax_id) == 8:
        return tax_id
    
    # éæ¨™æº–æ ¼å¼
    if tax_id.upper() in ['N', 'NAN']:
        return None
    
    return None
```

### 8. é›»è©±æ¸…æ´—è¦å‰‡

```python
def clean_phone(phone):
    """
    0910606816 â†’ "0910606816"
    933189163.0 â†’ "0933189163" (è£œ0)
    """
    if pd.isna(phone):
        return None
    
    phone = str(phone).strip()
    
    # ç§»é™¤å°æ•¸é»
    if '.' in phone:
        phone = phone.split('.')[0]
    
    # ç§»é™¤éæ•¸å­—
    phone = re.sub(r'\D', '', phone)
    
    # è‹¥ç‚º9ä½æ•¸ä¸”é–‹é ­ç‚º9,è£œ0
    if len(phone) == 9 and phone[0] == '9':
        phone = '0' + phone
    
    # é©—è­‰æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ 09XXXXXXXX
    if len(phone) == 10 and phone.startswith('09'):
        return phone
    
    return None
```

---

## ğŸ”§ ETL è™•ç†æµç¨‹

### Phase 1: è³‡æ–™æŠ½å– (Extract)

```python
# 1. è®€å–æ‰€æœ‰Excelæª”æ¡ˆ
df_hq_active = pd.read_excel('å®¢æˆ¶è³‡æ–™è¡¨crm.xlsx', sheet_name='ç¸½è¡¨')
df_hq_closed = pd.read_excel('å®¢æˆ¶è³‡æ–™è¡¨crm.xlsx', sheet_name='å·²çµæŸ')
df_hq_commission = pd.read_excel('å®¢æˆ¶è³‡æ–™è¡¨crm.xlsx', sheet_name='ä½£é‡‘')

df_hr_active = pd.read_excel('ç’°ç‘å®¢æˆ¶è³‡æ–™è¡¨crm.xlsx', sheet_name='ç’°ç‘CRM')
df_hr_closed = pd.read_excel('ç’°ç‘å®¢æˆ¶è³‡æ–™è¡¨crm.xlsx', sheet_name='å·²çµæŸ')
df_hr_commission = pd.read_excel('ç’°ç‘å®¢æˆ¶è³‡æ–™è¡¨crm.xlsx', sheet_name='ä½£é‡‘')

# 2. è®€å–ç¹³è²»è¡¨ (12å€‹æœˆä»½)
payments_2025 = {}
payments_2026 = {}
for month in range(1, 13):
    payments_2025[month] = pd.read_excel('2025_å®¢æˆ¶ç¹³è²».xlsx', sheet_name=f'{month}æœˆ')
    payments_2026[month] = pd.read_excel('2026å®¢æˆ¶ç¹³è²».xlsx', sheet_name=f'{month}æœˆ')
```

### Phase 2: è³‡æ–™è½‰æ› (Transform)

```python
# æ­¥é©Ÿ 1: æ¸…æ´—å®¢æˆ¶ä¸»æª”
def transform_customer(df, location_prefix):
    """
    è½‰æ›å®¢æˆ¶è³‡æ–™
    location_prefix: 'HQ' æˆ– 'HR'
    """
    df_clean = df.copy()
    
    # 1. å»ºç«‹ legacy_id
    df_clean['legacy_id'] = location_prefix + '-' + df_clean['ç·¨è™Ÿ'].astype(str)
    
    # 2. æ¸…æ´—å§“å (å¿…å¡«)
    df_clean['name'] = df_clean['å§“å'].str.strip()
    df_clean = df_clean[df_clean['name'].notna()]
    
    # 3. æ¸…æ´—å…¬å¸åç¨±
    df_clean['company_name'] = df_clean['å…¬å¸'].fillna('å€‹äºº')
    
    # 4. æ¸…æ´—çµ±ç·¨
    df_clean['company_tax_id'] = df_clean['Co number'].apply(clean_tax_id)
    
    # 5. æ¸…æ´—èº«ä»½è­‰å­—è™Ÿ
    df_clean['id_number'] = df_clean['Id number'].str.upper()
    
    # 6. è½‰æ›æ—¥æœŸ
    df_clean['birthday'] = df_clean['ç”Ÿæ—¥'].apply(convert_date)
    
    # 7. æ¸…æ´—é›»è©±
    df_clean['phone'] = df_clean['è¯çµ¡é›»è©±'].apply(clean_phone)
    
    # 8. æ˜ å°„é¡åˆ¥
    df_clean['customer_type'] = df_clean['é¡åˆ¥'].map({
        'è¡Œè™Ÿ': 'sole_proprietorship',
        'å…¬å¸': 'company',
        'N': 'individual'
    }).fillna('individual')
    
    # 9. æ¸…æ´—åœ°å€
    df_clean['address'] = df_clean['Add']
    
    # 10. Email
    df_clean['email'] = df_clean['Mail']
    
    # 11. è¡Œæ¥­å‚™è¨»
    df_clean['industry_notes'] = df_clean['è¡Œæ¥­å‚™è¨»']
    
    return df_clean

# æ­¥é©Ÿ 2: æ¸…æ´—åˆç´„è³‡æ–™
def transform_contract(df):
    """è½‰æ›åˆç´„è³‡æ–™"""
    df_clean = df.copy()
    
    # 1. æ—¥æœŸè½‰æ›
    df_clean['start_date'] = df_clean['èµ·å§‹æ—¥æœŸ'].apply(convert_date)
    df_clean['end_date'] = df_clean['åˆç´„åˆ°æœŸæ—¥'].apply(convert_date)
    df_clean['signed_at'] = df_clean['ç°½ç´„æ—¥æœŸ'].apply(convert_date)
    
    # 2. é‡‘é¡æå–
    df_clean['monthly_rent'] = df_clean['é‡‘é¡'].apply(extract_amount)
    
    # 3. æŠ¼é‡‘æ‹†åˆ†
    df_clean[['deposit', 'deposit_status']] = df_clean['æŠ¼é‡‘'].apply(
        lambda x: pd.Series(parse_deposit(x))
    )
    
    # 4. ç¹³è²»æ–¹å¼æ˜ å°„
    payment_cycle_map = {
        'Y': 'annual', 'y': 'annual',
        'M': 'monthly',
        '6M': 'semi_annual', '6m': 'semi_annual',
        '2Y': 'biennial', '2y': 'biennial'
    }
    df_clean['payment_cycle'] = df_clean['ç¹³è²»æ–¹å¼'].map(payment_cycle_map).fillna('monthly')
    
    # 5. åˆç´„é¡å‹æ˜ å°„
    contract_type_map = {
        'ç‡Ÿç™»': 'virtual_office',
        'è‡ªç”±åº§': 'coworking_flexible',
        'è¾¦å…¬å®¤A': 'coworking_fixed',
        'è¾¦å…¬å®¤': 'coworking_fixed'
    }
    df_clean['contract_type'] = df_clean['é …ç›®'].map(contract_type_map).fillna('virtual_office')
    
    # 6. åˆç´„ç‹€æ…‹
    # è‹¥åœ¨ã€Œå·²çµæŸã€å·¥ä½œè¡¨ â†’ terminated
    # è‹¥åœ¨ã€Œç¸½è¡¨ã€ä¸”åˆ°æœŸæ—¥ < ä»Šå¤© â†’ expired
    # è‹¥åœ¨ã€Œç¸½è¡¨ã€ä¸”åˆ°æœŸæ—¥ >= ä»Šå¤© â†’ active
    
    return df_clean

# æ­¥é©Ÿ 3: æ¸…æ´—ä½£é‡‘è³‡æ–™
def transform_commission(df):
    """è½‰æ›ä½£é‡‘è³‡æ–™"""
    df_clean = df.copy()
    
    # 1. æå–é‡‘é¡
    df_clean['commission_amount'] = df_clean['é‡‘é¡'].apply(extract_amount)
    
    # 2. è½‰æ›æ—¥æœŸ
    df_clean['contract_start'] = df_clean['ç°½ç´„æ™‚é–“'].apply(convert_date)
    
    # 3. ä»˜æ¬¾ç‹€æ…‹
    df_clean['status'] = df_clean['ä½£é‡‘çµ¦ä»˜æ—¥æœŸ'].apply(
        lambda x: 'paid' if (pd.notna(x) and 'å·²ä»˜' in str(x)) else 'pending'
    )
    
    # 4. è½‰æ›ä»˜æ¬¾æ—¥æœŸ
    df_clean['paid_at'] = df_clean['ä½£é‡‘çµ¦ä»˜æ—¥æœŸ'].apply(
        lambda x: convert_date(x) if (pd.notna(x) and 'å·²ä»˜' not in str(x)) else None
    )
    
    return df_clean
```

### Phase 3: è³‡æ–™è¼‰å…¥ (Load)

```python
# 1. å¯«å…¥ customers è¡¨
customers_hq = transform_customer(df_hq_active, 'HQ')
customers_hr = transform_customer(df_hr_active, 'HR')
customers_all = pd.concat([customers_hq, customers_hr], ignore_index=True)

# INSERT INTO customers...

# 2. å¯«å…¥ contracts è¡¨
contracts_hq = transform_contract(df_hq_active)
contracts_hr = transform_contract(df_hr_active)
contracts_all = pd.concat([contracts_hq, contracts_hr], ignore_index=True)

# INSERT INTO contracts...

# 3. å¯«å…¥ commission_payments è¡¨
# (éœ€è¦å…ˆå»ºç«‹ accounting_firms è¡¨)

# 4. å¯«å…¥ payments è¡¨
# (å¾ç¹³è²»è¡¨æ•´åˆ)
```

---

## âœ… è³‡æ–™é©—è­‰æª¢æŸ¥æ¸…å–®

### é·ç§»å‰é©—è­‰

â–¡ **è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥**
  - [ ] ç¢ºèªæ‰€æœ‰Excelæª”æ¡ˆå¯æ­£å¸¸é–‹å•Ÿ
  - [ ] ç¢ºèªå·¥ä½œè¡¨åç¨±æ­£ç¢º
  - [ ] çµ±è¨ˆç¸½è¡Œæ•¸èˆ‡é æœŸç›¸ç¬¦
  - [ ] æª¢æŸ¥æ˜¯å¦æœ‰éš±è—çš„å·¥ä½œè¡¨

â–¡ **å¿…è¦æ¬„ä½æª¢æŸ¥**
  - [ ] å§“åæ¬„ä½ç¼ºå¤±ç‡ < 5%
  - [ ] å…¬å¸/çµ±ç·¨è‡³å°‘ä¸€å€‹æœ‰å€¼
  - [ ] èµ·å§‹æ—¥æœŸæœ‰å€¼çš„æ¯”ä¾‹ > 80%

â–¡ **è³‡æ–™æ ¼å¼åˆæ­¥æª¢æŸ¥**
  - [ ] æ—¥æœŸæ¬„ä½æ ¼å¼çµ±è¨ˆ
  - [ ] é‡‘é¡æ¬„ä½æ ¼å¼çµ±è¨ˆ
  - [ ] é›»è©±è™Ÿç¢¼æ ¼å¼çµ±è¨ˆ

### é·ç§»å¾Œé©—è­‰

â–¡ **è³‡æ–™ç­†æ•¸é©—è­‰**
  ```sql
  -- 1. å®¢æˆ¶ç­†æ•¸
  SELECT 
    'ç¸½å®¢æˆ¶æ•¸' as item,
    COUNT(*) as count,
    215 as expected
  FROM customers;
  
  -- 2. æ´»èºåˆç´„æ•¸
  SELECT 
    'æ´»èºåˆç´„' as item,
    COUNT(*) as count
  FROM contracts 
  WHERE contract_status = 'active';
  
  -- 3. ä½£é‡‘è¨˜éŒ„
  SELECT 
    'ä½£é‡‘è¨˜éŒ„' as item,
    COUNT(*) as count,
    26 as expected
  FROM commission_payments;
  ```

â–¡ **è³‡æ–™å®Œæ•´æ€§é©—è­‰**
  ```sql
  -- 1. å¿…å¡«æ¬„ä½æª¢æŸ¥
  SELECT 
    COUNT(*) as total,
    COUNT(name) as has_name,
    COUNT(phone) as has_phone
  FROM customers;
  
  -- 2. å¤–éµé—œè¯æª¢æŸ¥
  SELECT 
    c.id,
    c.customer_id,
    cust.name
  FROM contracts c
  LEFT JOIN customers cust ON c.customer_id = cust.id
  WHERE cust.id IS NULL;
  ```

â–¡ **æ¥­å‹™é‚è¼¯é©—è­‰**
  ```sql
  -- 1. åˆç´„æœŸé–“æª¢æŸ¥ (end_date æ‡‰è©² > start_date)
  SELECT id, start_date, end_date
  FROM contracts
  WHERE end_date <= start_date;
  
  -- 2. ç§Ÿé‡‘åˆç†æ€§æª¢æŸ¥
  SELECT id, monthly_rent
  FROM contracts
  WHERE monthly_rent < 1000 OR monthly_rent > 20000;
  
  -- 3. æŠ¼é‡‘åˆç†æ€§æª¢æŸ¥
  SELECT id, deposit, monthly_rent
  FROM contracts
  WHERE deposit < monthly_rent * 0.5 OR deposit > monthly_rent * 5;
  ```

â–¡ **è³‡æ–™å“è³ªæŠ½æŸ¥**
  - [ ] éš¨æ©ŸæŠ½æŸ¥20ç­†å®¢æˆ¶,äººå·¥æ¯”å°åŸå§‹Excel
  - [ ] æª¢æŸ¥æ—¥æœŸè½‰æ›æ˜¯å¦æ­£ç¢º (æ°‘åœ‹ â†’ è¥¿å…ƒ)
  - [ ] æª¢æŸ¥é‡‘é¡æå–æ˜¯å¦æ­£ç¢º
  - [ ] æª¢æŸ¥é›»è©±è™Ÿç¢¼æ ¼å¼

â–¡ **ç•°å¸¸å€¼å ±å‘Š**
  ```sql
  -- ç”¢ç”Ÿç•°å¸¸å€¼å ±å‘Š
  SELECT 
    'phone_invalid' as issue,
    COUNT(*) as count
  FROM customers
  WHERE phone IS NOT NULL 
    AND (LENGTH(phone) != 10 OR LEFT(phone, 2) != '09');
  ```

---

## ğŸš¨ é·ç§»é¢¨éšªèˆ‡æ‡‰å°

### é«˜é¢¨éšªé …ç›®

1. **ç¹³è²»è¡¨ç„¡æ³•é—œè¯åˆ°å®¢æˆ¶**
   - **é¢¨éšª:** ç¹³è²»è¡¨çš„ Unnamed: 0 (ç·¨è™Ÿ) å¯èƒ½èˆ‡å®¢æˆ¶ä¸»æª”ä¸ä¸€è‡´
   - **æ‡‰å°:** 
     - å…ˆç”¨ç·¨è™Ÿå˜—è©¦é—œè¯
     - å¤±æ•—å‰‡ç”¨å§“å + å…¬å¸åç¨±æ¨¡ç³Šæ¯”å°
     - æœ€å¾Œå‰©é¤˜çš„å»ºç«‹ã€Œå¾…ç¢ºèªç¹³è²»è¨˜éŒ„ã€è¡¨

2. **ä½£é‡‘ç„¡æ³•è¿½æº¯åˆ°äº‹å‹™æ‰€**
   - **é¢¨éšª:** ã€Œä»‹ç´¹äººã€æ¬„ä½åªæœ‰åå­—,æ²’æœ‰å®Œæ•´äº‹å‹™æ‰€è³‡è¨Š
   - **æ‡‰å°:**
     - å»ºç«‹ã€Œä»‹ç´¹äºº â†’ äº‹å‹™æ‰€ã€å°æ‡‰è¡¨
     - å…ˆè®“è±ªå»·æ‰‹å‹•ç¢ºèªé€™26ç­†ä»‹ç´¹äººå°æ‡‰å“ªäº›äº‹å‹™æ‰€
     - æœªä¾†æ–°å¢äº‹å‹™æ‰€master table

3. **æ—¥æœŸç•°å¸¸å€¼**
   - **é¢¨éšª:** `11408/17` é€™ç¨®éŒ¯èª¤æ—¥æœŸ
   - **æ‡‰å°:**
     - è¨˜éŒ„ç•°å¸¸æ—¥æœŸæ¸…å–®
     - äººå·¥ç¢ºèªå¾Œä¿®æ­£
     - å¯¦åœ¨ç„¡æ³•ç¢ºèªçš„è¨­ç‚ºNULL

### ä¸­é¢¨éšªé …ç›®

4. **å®¢æˆ¶é‡è¤‡å•é¡Œ**
   - **é¢¨éšª:** åŒä¸€å®¢æˆ¶å¯èƒ½åœ¨å…©å€‹é¤¨éƒ½æœ‰ç´€éŒ„
   - **æ‡‰å°:**
     - ç”¨ (å§“å + çµ±ç·¨) æˆ– (å§“å + é›»è©±) æ¯”å°
     - ç™¼ç¾é‡è¤‡æ™‚åˆä½µç‚ºä¸€ç­†å®¢æˆ¶,ä½†ä¿ç•™å…©ä»½åˆç´„

5. **æ­·å²è³‡æ–™ä¸å®Œæ•´**
   - **é¢¨éšª:** ã€Œå·²çµæŸã€å·¥ä½œè¡¨è³‡æ–™è¼ƒå°‘
   - **æ‡‰å°:**
     - å…ˆé·ç§»æ´»èºå®¢æˆ¶
     - æ­·å²å®¢æˆ¶è¨­ç‚º status='churned'
     - æ¨™è¨˜ã€Œè³‡æ–™ä¾†æºç‚ºèˆŠç³»çµ±ã€

---

## ğŸ“… é·ç§»æ™‚ç¨‹è¦åŠƒ

### Week 1: æº–å‚™éšæ®µ
- Day 1-2: ç¢ºèªæ¬„ä½å°æ‡‰è¡¨
- Day 3-4: é–‹ç™¼ ETL è…³æœ¬
- Day 5: æ¸¬è©¦ç’°å¢ƒè©¦è·‘

### Week 2: åŸ·è¡Œéšæ®µ
- Day 1: é·ç§»å®¢æˆ¶ä¸»æª”
- Day 2: é·ç§»åˆç´„è³‡æ–™
- Day 3: é·ç§»ä½£é‡‘è³‡æ–™
- Day 4: é·ç§»ç¹³è²»è¨˜éŒ„ (ç›¡åŠ›è€Œç‚º)
- Day 5: è³‡æ–™é©—è­‰

### Week 3: é©—è­‰éšæ®µ
- Day 1-2: æŠ½æŸ¥é©—è­‰
- Day 3: ç•°å¸¸å€¼è™•ç†
- Day 4: è£œå……ç¼ºå¤±è³‡æ–™
- Day 5: æœ€çµ‚ç¢ºèª

---

## ğŸ’¾ å‚™ä»½ç­–ç•¥

### é·ç§»å‰
1. å‚™ä»½æ‰€æœ‰åŸå§‹Excelæª”æ¡ˆ
2. å»ºç«‹ `migration_backup` è³‡æ–™å¤¾
3. æ‰€æœ‰æª”æ¡ˆåŠ ä¸Šæ™‚é–“æˆ³è¨˜

### é·ç§»ä¸­
1. æ¯å€‹æ­¥é©ŸåŸ·è¡Œå‰å‚™ä»½è³‡æ–™åº«
2. ä¿ç•™æ¯æ¬¡è½‰æ›çš„ä¸­é–“çµæœ (CSV)
3. è¨˜éŒ„æ‰€æœ‰ SQL åŸ·è¡Œæ—¥èªŒ

### é·ç§»å¾Œ
1. ä¿ç•™åŸå§‹Excelæª”æ¡ˆè‡³å°‘1å¹´
2. æ–°èˆŠç³»çµ±ä¸¦è¡Œé‹ä½œ1å€‹æœˆ
3. å®šæœŸåŒ¯å‡ºæ–°ç³»çµ±è³‡æ–™å‚™ä»½

---

## ğŸ› ï¸ å·¥å…·éœ€æ±‚

### Pythonå¥—ä»¶
```bash
pip install pandas openpyxl mysql-connector-python sqlalchemy --break-system-packages
```

### SQLå·¥å…·
- MySQL Workbench (è³‡æ–™é©—è­‰)
- DBeaver (è³‡æ–™æ¯”å°)

### Excelå·¥å…·
- Microsoft Excel (è³‡æ–™é è™•ç†)
- LibreOffice Calc (å‚™ç”¨)

---

## ğŸ“ å¾ŒçºŒæ”¹å–„å»ºè­°

### ç«‹å³æ”¹å–„ (é·ç§»å¾Œ)
1. **å»ºç«‹è³‡æ–™è¼¸å…¥è¦ç¯„**
   - çµ±ä¸€æ—¥æœŸæ ¼å¼
   - çµ±ä¸€é‡‘é¡æ ¼å¼
   - ä¸‹æ‹‰é¸å–®å–ä»£æ‰‹å‹•è¼¸å…¥

2. **å¿…å¡«æ¬„ä½åŠ å¼·**
   - å§“åå¿…å¡«
   - é›»è©±å¿…å¡«
   - çµ±ç·¨æˆ–èº«ä»½è­‰æ“‡ä¸€å¿…å¡«

3. **è‡ªå‹•é©—è­‰**
   - çµ±ç·¨é©—è­‰API
   - é›»è©±æ ¼å¼é©—è­‰
   - èº«ä»½è­‰æ ¼å¼é©—è­‰

### ä¸­æœŸæ”¹å–„ (3å€‹æœˆå…§)
1. **è‡ªå‹•åŒ–ç¹³è²»æé†’**
2. **åˆç´„åˆ°æœŸè‡ªå‹•é€šçŸ¥**
3. **ä½£é‡‘è‡ªå‹•è¨ˆç®—**

### é•·æœŸæ”¹å–„ (6å€‹æœˆå…§)
1. **LINE Bot æ•´åˆ**
2. **é›»å­ç°½åæ•´åˆ**
3. **è‡ªå‹•é–‹ç™¼ç¥¨**

---

**æ–‡ä»¶ç‰ˆæœ¬:** v1.0  
**æœ€å¾Œæ›´æ–°:** 2025-12-03  
**è² è²¬äºº:** æˆ´è±ªå»·  
**æŠ€è¡“æ”¯æ´:** Claude (Anthropic)
